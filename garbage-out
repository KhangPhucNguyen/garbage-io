#!/bin/bash

target="${1:-.}"
. garbage-conf

cur_size="$(du -s "$target" | awk '{print $1}')"
if [[ "$cur_size" -gt "$limit_size" ]]
then
    find "$target" -type f -regextype sed -regex ".*.$stamp-[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}_[0-9]\{2\}-[0-9]\{2\}-[0-9]\{2\}" -printf "%f;%p\n" |
        perl -pe 's|.*?GARBAGE-||' |
        sort |
        while read garbage
            do
                timestamp="$(echo "$garbage" | cut -d ';' -f 1)"
                path="$(echo "$garbage" | cut -d ';' -f 2)"
                [[ "$timestamp" -gt "$(date --date=yesterday +'%Y-%m-%d_%H-%M-%S')" ]] && break
                rm "$path"
                cur_size="$(du -s "$target" | awk '{print $1}')"
                [[ "$cur_size" -lt "$limit_size" ]] && break
            done
fi

find "$target" -type d -empty -exec rmdir {} \;
